# åœ¨çº¿è€ƒè¯•ç³»ç»Ÿå‹åŠ›æµ‹è¯•

æœ¬ç›®å½•åŒ…å«äº†é’ˆå¯¹åœ¨çº¿è€ƒè¯•ç³»ç»Ÿçš„å®Œæ•´å‹åŠ›æµ‹è¯•å¥—ä»¶ï¼Œç¡®ä¿ç³»ç»Ÿèƒ½å¤Ÿæ‰¿å—50ä¸ªè™šæ‹Ÿç”¨æˆ·(VU)çš„å¹¶å‘è®¿é—®ï¼Œä¸”95%çš„å“åº”æ—¶é—´ä¸è¶…è¿‡100msã€‚

## ğŸ“‹ æµ‹è¯•ç›®æ ‡

- **å¹¶å‘ç”¨æˆ·æ•°**: 50 VU
- **95%å“åº”æ—¶é—´**: < 100ms
- **é”™è¯¯ç‡**: < 5%
- **æµ‹è¯•å·¥å…·**: k6

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–

#### macOS
```bash
brew install k6
```

#### Ubuntu/Debian
```bash
sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
echo "deb https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
sudo apt-get update && sudo apt-get install k6
```

#### Windows
```powershell
choco install k6
```

### 2. å¯åŠ¨åç«¯æœåŠ¡

ç¡®ä¿åç«¯æœåŠ¡åœ¨ `http://localhost:8080` è¿è¡Œï¼š

```bash
cd ../backend
go run main.go
```

### 3. è¿è¡Œå‹åŠ›æµ‹è¯•

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x run-load-tests.sh

# è¿è¡Œæ‰€æœ‰æµ‹è¯•
./run-load-tests.sh all

# æˆ–è¿è¡Œç‰¹å®šæµ‹è¯•
./run-load-tests.sh quick      # å¿«é€ŸéªŒè¯
./run-load-tests.sh core       # æ ¸å¿ƒæ¥å£æµ‹è¯•
./run-load-tests.sh admin      # ç®¡ç†æ¥å£æµ‹è¯•
```

## ğŸ“ æ–‡ä»¶è¯´æ˜

### æµ‹è¯•è„šæœ¬

| æ–‡ä»¶ | æè¿° | ç›®æ ‡ç”¨æˆ· | å¹¶å‘æ•° |
|------|------|----------|--------|
| `k6-load-test.js` | ç»¼åˆAPIå‹åŠ›æµ‹è¯• | æ‰€æœ‰è§’è‰² | 50 VU |
| `k6-core-apis-test.js` | æ ¸å¿ƒä¸šåŠ¡æ¥å£æµ‹è¯• | ä¸»è¦æ˜¯å­¦ç”Ÿ | 50 VU |
| `k6-admin-teacher-test.js` | ç®¡ç†æ¥å£æµ‹è¯• | æ•™å¸ˆ/ç®¡ç†å‘˜ | 15 VU |
| `run-load-tests.sh` | æµ‹è¯•æ‰§è¡Œè„šæœ¬ | - | - |

### æµ‹è¯•è¦†ç›–çš„æ¥å£

#### ğŸ“ å­¦ç”Ÿæ¥å£ (é«˜é¢‘)
- `POST /api/v1/auth/login` - ç”¨æˆ·ç™»å½•
- `GET /api/v1/practice/recommendations` - è·å–ç»ƒä¹ æ¨è
- `POST /api/v1/practice/start` - å¼€å§‹ç»ƒä¹ 
- `POST /api/v1/practice/{id}/answer` - æäº¤ç»ƒä¹ ç­”æ¡ˆ
- `GET /api/v1/practice/history` - ç»ƒä¹ å†å²
- `GET /api/v1/practice/stats` - ç»ƒä¹ ç»Ÿè®¡
- `GET /api/v1/exams/student` - å­¦ç”Ÿè€ƒè¯•åˆ—è¡¨
- `POST /api/v1/exams/{id}/start` - å¼€å§‹è€ƒè¯•
- `GET /api/v1/user/profile` - ç”¨æˆ·èµ„æ–™

#### ğŸ‘¨â€ğŸ« æ•™å¸ˆæ¥å£ (ä¸­é¢‘)
- `GET /api/v1/questions` - é¢˜ç›®åˆ—è¡¨
- `POST /api/v1/teacher/questions` - åˆ›å»ºé¢˜ç›®
- `GET /api/v1/papers` - è¯•å·åˆ—è¡¨
- `POST /api/v1/teacher/papers/auto` - è‡ªåŠ¨ç»„å·
- `GET /api/v1/exams` - è€ƒè¯•åˆ—è¡¨
- `POST /api/v1/teacher/exams` - åˆ›å»ºè€ƒè¯•
- `GET /api/v1/stats/teacher` - æ•™å¸ˆç»Ÿè®¡

#### ğŸ‘‘ ç®¡ç†å‘˜æ¥å£ (ä½é¢‘)
- `GET /api/v1/admin/dashboard` - ç®¡ç†å‘˜ä»ªè¡¨æ¿
- `GET /api/v1/admin/users` - ç”¨æˆ·ç®¡ç†
- `GET /api/v1/subjects/all` - ç§‘ç›®ç®¡ç†

#### ğŸ”§ å…¬å…±æ¥å£
- `GET /api/v1/health` - å¥åº·æ£€æŸ¥
- `GET /api/v1/subjects` - ç§‘ç›®åˆ—è¡¨

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### å…³é”®æŒ‡æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| `http_req_duration p(95)` | < 100ms | 95%è¯·æ±‚å“åº”æ—¶é—´ |
| `http_req_failed rate` | < 5% | è¯·æ±‚å¤±è´¥ç‡ |
| `http_reqs` | - | æ€»è¯·æ±‚æ•° |
| `vus` | 50 | è™šæ‹Ÿç”¨æˆ·æ•° |
| `vus_max` | 50 | æœ€å¤§è™šæ‹Ÿç”¨æˆ·æ•° |

### è‡ªå®šä¹‰æŒ‡æ ‡

- `errors` - è‡ªå®šä¹‰é”™è¯¯ç‡
- `practice_start_errors` - ç»ƒä¹ å¼€å§‹é”™è¯¯ç‡
- `exam_start_errors` - è€ƒè¯•å¼€å§‹é”™è¯¯ç‡
- `create_question_errors` - åˆ›å»ºé¢˜ç›®é”™è¯¯ç‡
- `create_exam_errors` - åˆ›å»ºè€ƒè¯•é”™è¯¯ç‡

## ğŸ§ª æµ‹è¯•åœºæ™¯

### 1. ç»¼åˆå‹åŠ›æµ‹è¯• (`k6-load-test.js`)

**æµ‹è¯•é˜¶æ®µ**:
- é¢„çƒ­: 2åˆ†é’Ÿå†…å¢åŠ åˆ°10ç”¨æˆ·
- å‹åŠ›: 5åˆ†é’Ÿå†…å¢åŠ åˆ°50ç”¨æˆ·
- ç¨³å®š: ä¿æŒ50ç”¨æˆ·10åˆ†é’Ÿ
- å†·å´: 2åˆ†é’Ÿå†…å‡å°‘åˆ°0ç”¨æˆ·

**æµ‹è¯•å†…å®¹**: è¦†ç›–æ‰€æœ‰è§’è‰²çš„å¸¸ç”¨æ¥å£

### 2. æ ¸å¿ƒä¸šåŠ¡æµ‹è¯• (`k6-core-apis-test.js`)

**æµ‹è¯•é˜¶æ®µ**:
- å¿«é€Ÿé¢„çƒ­: 1åˆ†é’Ÿåˆ°20ç”¨æˆ·
- å‹åŠ›å¢åŠ : 3åˆ†é’Ÿåˆ°50ç”¨æˆ·
- é«˜å¼ºåº¦: ä¿æŒ50ç”¨æˆ·15åˆ†é’Ÿ
- é€æ­¥é™ä½: 3åˆ†é’Ÿåˆ°0ç”¨æˆ·

**æµ‹è¯•å†…å®¹**: é‡ç‚¹æµ‹è¯•å­¦ç”Ÿç»ƒä¹ å’Œè€ƒè¯•æµç¨‹

### 3. ç®¡ç†æ¥å£æµ‹è¯• (`k6-admin-teacher-test.js`)

**æµ‹è¯•é˜¶æ®µ**:
- é¢„çƒ­: 1åˆ†é’Ÿåˆ°5ç”¨æˆ·
- å¢åŠ : 3åˆ†é’Ÿåˆ°15ç”¨æˆ·
- ç¨³å®š: ä¿æŒ15ç”¨æˆ·10åˆ†é’Ÿ
- ç»“æŸ: 2åˆ†é’Ÿåˆ°0ç”¨æˆ·

**æµ‹è¯•å†…å®¹**: æ•™å¸ˆå’Œç®¡ç†å‘˜çš„ç®¡ç†æ“ä½œ

## ğŸ“ˆ æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•å®Œæˆåï¼ŒæŠ¥å‘Šå°†ä¿å­˜åœ¨ `reports/YYYYMMDD_HHMMSS/` ç›®å½•ä¸‹ï¼š

```
reports/
â””â”€â”€ 20241201_143022/
    â”œâ”€â”€ comprehensive-test.json    # ç»¼åˆæµ‹è¯•è¯¦ç»†æ•°æ®
    â”œâ”€â”€ comprehensive-test.csv     # ç»¼åˆæµ‹è¯•CSVæ ¼å¼
    â”œâ”€â”€ core-apis-test.json        # æ ¸å¿ƒæ¥å£æµ‹è¯•æ•°æ®
    â”œâ”€â”€ core-apis-test.csv         # æ ¸å¿ƒæ¥å£æµ‹è¯•CSV
    â”œâ”€â”€ admin-teacher-test.json    # ç®¡ç†æ¥å£æµ‹è¯•æ•°æ®
    â”œâ”€â”€ admin-teacher-test.csv     # ç®¡ç†æ¥å£æµ‹è¯•CSV
    â””â”€â”€ test-summary.txt           # æµ‹è¯•æ‘˜è¦
```

## ğŸ” ç»“æœåˆ†æ

### æŸ¥çœ‹å®æ—¶ç»“æœ

```bash
# è¿è¡Œæµ‹è¯•æ—¶ä¼šæ˜¾ç¤ºå®æ—¶ç»Ÿè®¡
k6 run k6-load-test.js
```

### åˆ†æJSONæŠ¥å‘Š

```bash
# ä½¿ç”¨jqåˆ†æJSONæŠ¥å‘Š
cat reports/*/comprehensive-test.json | jq '.metrics.http_req_duration'
```

### å…³é”®æ£€æŸ¥ç‚¹

1. **å“åº”æ—¶é—´**: ç¡®ä¿95%è¯·æ±‚ < 100ms
2. **é”™è¯¯ç‡**: ç¡®ä¿ < 5%
3. **ååé‡**: æ£€æŸ¥æ¯ç§’è¯·æ±‚æ•°(RPS)
4. **èµ„æºä½¿ç”¨**: ç›‘æ§CPUã€å†…å­˜ä½¿ç”¨æƒ…å†µ

## ğŸ› ï¸ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **è¿æ¥è¢«æ‹’ç»**
   ```
   é”™è¯¯: dial tcp 127.0.0.1:8080: connect: connection refused
   ```
   **è§£å†³**: ç¡®ä¿åç«¯æœåŠ¡æ­£åœ¨è¿è¡Œ

2. **è®¤è¯å¤±è´¥**
   ```
   é”™è¯¯: login status is not 200
   ```
   **è§£å†³**: æ£€æŸ¥æµ‹è¯•ç”¨æˆ·æ˜¯å¦å­˜åœ¨ï¼Œå¯†ç æ˜¯å¦æ­£ç¡®

3. **å“åº”æ—¶é—´è¿‡é•¿**
   ```
   é˜ˆå€¼å¤±è´¥: http_req_duration p(95) > 100ms
   ```
   **è§£å†³**: æ£€æŸ¥æ•°æ®åº“ç´¢å¼•ã€æœåŠ¡å™¨èµ„æº

### è°ƒè¯•æŠ€å·§

1. **å¢åŠ æ—¥å¿—è¾“å‡º**:
   ```javascript
   console.log('Response:', response.body);
   ```

2. **é™ä½å¹¶å‘æ•°**:
   ```javascript
   stages: [{ duration: '1m', target: 10 }]
   ```

3. **å•ç‹¬æµ‹è¯•æ¥å£**:
   ```bash
   k6 run --vus 1 --duration 30s k6-load-test.js
   ```

## ğŸ“ è‡ªå®šä¹‰æµ‹è¯•

### ä¿®æ”¹æµ‹è¯•å‚æ•°

```javascript
// åœ¨æµ‹è¯•æ–‡ä»¶ä¸­ä¿®æ”¹
export const options = {
  stages: [
    { duration: '2m', target: 20 }, // ä¿®æ”¹ç›®æ ‡ç”¨æˆ·æ•°
  ],
  thresholds: {
    http_req_duration: ['p(95)<150'], // ä¿®æ”¹å“åº”æ—¶é—´é˜ˆå€¼
  },
};
```

### æ·»åŠ æ–°çš„æµ‹è¯•æ¥å£

```javascript
function testNewAPI(token) {
  const params = { headers: getAuthHeaders(token) };
  const response = http.get(`${BASE_URL}/new-endpoint`, params);
  
  check(response, {
    'new API status 200': (r) => r.status === 200,
    'new API RT < 100ms': (r) => r.timings.duration < 100,
  });
}
```

## ğŸ¯ æ€§èƒ½ä¼˜åŒ–å»ºè®®

åŸºäºæµ‹è¯•ç»“æœï¼Œå¯èƒ½çš„ä¼˜åŒ–æ–¹å‘ï¼š

1. **æ•°æ®åº“ä¼˜åŒ–**
   - æ·»åŠ é€‚å½“çš„ç´¢å¼•
   - ä¼˜åŒ–æŸ¥è¯¢è¯­å¥
   - ä½¿ç”¨è¿æ¥æ± 

2. **ç¼“å­˜ç­–ç•¥**
   - Redisç¼“å­˜çƒ­ç‚¹æ•°æ®
   - é™æ€èµ„æºCDN
   - æ¥å£å“åº”ç¼“å­˜

3. **ä»£ç ä¼˜åŒ–**
   - å‡å°‘æ•°æ®åº“æŸ¥è¯¢æ¬¡æ•°
   - å¼‚æ­¥å¤„ç†éå…³é”®æ“ä½œ
   - ä¼˜åŒ–ç®—æ³•å¤æ‚åº¦

4. **åŸºç¡€è®¾æ–½**
   - å¢åŠ æœåŠ¡å™¨èµ„æº
   - è´Ÿè½½å‡è¡¡
   - æ•°æ®åº“è¯»å†™åˆ†ç¦»

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š
1. åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. æµ‹è¯•ç”¨æˆ·æ•°æ®æ˜¯å¦æ­£ç¡®
3. ç½‘ç»œè¿æ¥æ˜¯å¦ç¨³å®š
4. k6ç‰ˆæœ¬æ˜¯å¦æœ€æ–°

---

**æ³¨æ„**: è¯·åœ¨æµ‹è¯•ç¯å¢ƒä¸­è¿è¡Œå‹åŠ›æµ‹è¯•ï¼Œé¿å…å¯¹ç”Ÿäº§ç¯å¢ƒé€ æˆå½±å“ã€‚